This is edited from the tuf49524 branch.